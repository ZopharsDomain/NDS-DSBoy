.ARM
.ALIGN

gb_opc	.req r3
gb_flg 	.req r4
gb_a 	.req r5
gb_bc 	.req r6
gb_de 	.req r7
gb_hl 	.req r8
cycles 	.req r9
gb_pc 	.req r10
gb_cpu  .req r11

.extern ram

.set SP, 		0
.set IME, 		4
.set IMA, 		5
.set speed, 	6
.set halt, 		7
.set div, 		8
.set tim, 		12
.set lcdc, 		16
.set snd, 		20


.set R_KEY1,	0x4D	+ 24
.set R_IF,    	0x0F	+ 24
.set R_IE,    	0xFF	+ 24
.set R_DIV,		0x04	+ 24
.set R_TIMA, 	0x05	+ 24
.set R_TMA, 	0x06	+ 24
.set R_TAC,		0x07	+ 24
.set R_LY,		0x44	+ 24
.set R_LCDC,	0x40	+ 24


.include "d:/eclipse/workspace/DS_ASM/asm/macro.h"

.global  cpu_emulate
.type    cpu_emulate,function

.global  emu_run
.type    emu_run,function

.global  cpu_reset
.type    cpu_reset,function





_xx:		@	invalid opcode
	bl exit
	
@----------------------------------------------------------------------------
_40:		@	LD B,B
_49:		@	LD C,C
_52:		@	LD D,D
_5B:		@	LD E,E
_64:		@	LD H,H
_6D:		@	LD L,L
_7F:		@	LD A,A
_00: 		@   NOP
	fetch 1
@----------------------------------------------------------------------------
_01:		@	LD BC,#nnnn
@----------------------------------------------------------------------------	
	readPCWord
	mov gb_bc, r0, lsl#16
	fetch 3
@----------------------------------------------------------------------------
_02:		@	LD (BC),A	write A to (BC)
@----------------------------------------------------------------------------
	writeA16 gb_bc
	fetch 2
@----------------------------------------------------------------------------
_03:		@	INC BC
@----------------------------------------------------------------------------
	opINC16 gb_bc
	fetch 2
@----------------------------------------------------------------------------
_04:		@	INC B
@----------------------------------------------------------------------------
	opINC8H gb_bc
	fetch 1
@----------------------------------------------------------------------------
_05:		@	DEC B
@----------------------------------------------------------------------------
	opDEC8H gb_bc
	fetch 1
@----------------------------------------------------------------------------
_06:		@	LD B,#nn
@----------------------------------------------------------------------------
	readPCByte
	and gb_bc, gb_bc, #0x00FF0000
	orr gb_bc, gb_bc, r0, lsl#24
	fetch 2
@----------------------------------------------------------------------------
_07:		@	RLCA	rotate accu left
@----------------------------------------------------------------------------
	mov gb_flg,#0
	adds gb_a,gb_a,gb_a
	orrcs gb_flg,gb_flg,#PSR_C
	orrcs gb_a,gb_a,#0x01000000
	fetch 1
@----------------------------------------------------------------------------
_08:		@	LD (nnnn),SP	write SP to (nnnn)
@----------------------------------------------------------------------------
	readPCWord
	ldr r1, [gb_cpu,#SP]
	mov r1, r1, lsr#16
	writew
	fetch 5
@----------------------------------------------------------------------------
_09:		@	ADD HL,BC
@----------------------------------------------------------------------------
	opADD16 gb_bc
	fetch 2
@----------------------------------------------------------------------------
_0A:		@	LD A,(BC)
@----------------------------------------------------------------------------
	readA16 gb_bc
	fetch 2
@----------------------------------------------------------------------------
_0B:		@	DEC BC
@----------------------------------------------------------------------------
	opDEC16 gb_bc
	fetch 2
@----------------------------------------------------------------------------
_0C:		@	INC C
@----------------------------------------------------------------------------
	opINC8L gb_bc
	fetch 1
@----------------------------------------------------------------------------
_0D:		@	DEC C
@----------------------------------------------------------------------------
	opDEC8L gb_bc
	fetch 1
@----------------------------------------------------------------------------
_0E:		@	LD C,#nn
@----------------------------------------------------------------------------
	readPCByte
	and gb_bc, gb_bc, #0xFF000000
	orr gb_bc, gb_bc, r0, lsl#16
	fetch 2
@----------------------------------------------------------------------------
_0F:		@	RRCA	rotate accu right
@----------------------------------------------------------------------------
	mov gb_flg,#0
	movs gb_a,gb_a,lsr#25
	orrcs gb_flg,gb_flg,#PSR_C
	orrcs gb_a,gb_a,#0x00000080
	mov gb_a,gb_a,lsl#24
	fetch 1
@----------------------------------------------------------------------------
_10:		@	STOP	stops the processor until an (joypad) interrupt.
@----------------------------------------------------------------------------
	add gb_pc,gb_pc,#0x00010000
	ldrb r1, [gb_cpu, #R_KEY1]
	tst r1,#1			
	beq _noStop
	ldrb  r2,[gb_cpu,#speed]
	eor r2,r2,#1
	strb r2,[gb_cpu,#speed]
	mov r2,r2,lsl#7
	and r1,r1,#0x7E 
	orr r1,r1,r2
	strb r1, [gb_cpu, #R_KEY1]	
_noStop:
	fetch 1
/*ramaddr:			TRICK TO LOAD ram object
	.word ram+R_KEY1	*/
@----------------------------------------------------------------------------
_11:		@	LD DE,#nnnn
@----------------------------------------------------------------------------
	readPCWord
	mov gb_de, r0, lsl#16
	fetch 3	
@----------------------------------------------------------------------------
_12:		@	LD (DE),A	write A to (DE)
@----------------------------------------------------------------------------
	writeA16 gb_de
	fetch 2
@----------------------------------------------------------------------------
_13:		@	INC DE
@----------------------------------------------------------------------------
	opINC16 gb_de
	fetch 2
@----------------------------------------------------------------------------
_14:		@	INC D
@----------------------------------------------------------------------------
	opINC8H gb_de
	fetch 1
@----------------------------------------------------------------------------
_15:		@	DEC D
@----------------------------------------------------------------------------
	opDEC8H gb_de
	fetch 1
@----------------------------------------------------------------------------
_16:		@	LD D,#nn
@----------------------------------------------------------------------------
	readPCByte
	and gb_de, gb_de, #0x00FF0000
	orr gb_de, gb_de, r0, lsl#24
	fetch 2
@----------------------------------------------------------------------------
_17:		@	RLA	rotate accu left through C
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	mov gb_flg,#0			@clear flags
	orrne gb_a,gb_a,#0x00800000
	adds gb_a,gb_a,gb_a
	orrcs gb_flg,gb_flg,#PSR_C
	fetch 1
@----------------------------------------------------------------------------
_18:		@	JR *	relative jump
@----------------------------------------------------------------------------
	readPCSigned
	add gb_pc,gb_pc,r0,lsl#16
	fetch 3
@----------------------------------------------------------------------------
_19:		@	ADD HL,DE
@----------------------------------------------------------------------------
	opADD16 gb_de
	fetch 2
@----------------------------------------------------------------------------
_1A:		@	LD A,(DE)
@----------------------------------------------------------------------------
	readA16 gb_de
	fetch 2
@----------------------------------------------------------------------------
_1B:		@	DEC DE
@----------------------------------------------------------------------------
	opDEC16 gb_de
	fetch 2
@----------------------------------------------------------------------------
_1C:		@	INC E
@----------------------------------------------------------------------------
	opINC8L gb_de
	fetch 1
@----------------------------------------------------------------------------
_1D:		@	DEC E
@----------------------------------------------------------------------------
	opDEC8L gb_de
	fetch 1
@----------------------------------------------------------------------------
_1E:		@	LD E,#nn
@----------------------------------------------------------------------------
	readPCByte
	and gb_de, gb_de, #0xFF000000
	orr gb_de, gb_de, r0, lsl#16
	fetch 2
@----------------------------------------------------------------------------
_1F:		@	RRA	rotate accu right through C
@----------------------------------------------------------------------------
	msr cpsr_f,gb_flg	@get C
	mov gb_flg,#0		@clear flags
	mov gb_a,gb_a,rrx
	tst gb_a,#0x00800000
	orrne gb_flg,gb_flg,#PSR_C
	bic gb_a,gb_a,#0x00800000
	fetch 1
@----------------------------------------------------------------------------
_20:		@	JR NZ,*	jump if not zero
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	beq _18
	add gb_pc, gb_pc, #0x00010000
	fetch 2
@----------------------------------------------------------------------------
_21:		@	LD HL,#nnnn
@----------------------------------------------------------------------------
	readPCWord
	mov gb_hl, r0, lsl#16
	fetch 3	
@----------------------------------------------------------------------------
_22:		@	LDI (HL),A	write A to (HL), incr HL
@----------------------------------------------------------------------------
	writeA16 gb_hl
	add gb_hl,gb_hl,#0x00010000
	fetch 2
@----------------------------------------------------------------------------
_23:		@	INC HL
@----------------------------------------------------------------------------
	opINC16 gb_hl
	fetch 2
@----------------------------------------------------------------------------
_24:		@	INC H
@----------------------------------------------------------------------------
	opINC8H gb_hl
	fetch 1
@----------------------------------------------------------------------------
_25:		@	DEC H
@----------------------------------------------------------------------------
	opDEC8H gb_hl
	fetch 1
@----------------------------------------------------------------------------
_26:		@	LD H,#nn
@----------------------------------------------------------------------------
	readPCByte
	and gb_hl, gb_hl, #0x00FF0000
	orr gb_hl, gb_hl, r0, lsl#24
	fetch 2
@----------------------------------------------------------------------------
_27:		@	DAA	decimal adjust ackumulator
@----------------------------------------------------------------------------
	mov r0,#0

	and r1,gb_a,#0x0F000000
	cmp r1,#0x0A000000
	orrpl r0,r0,#0x06000000
	cmppl gb_a,#0x90000000
	cmpmi gb_a,#0xA0000000
	orrhs gb_flg,gb_flg,#PSR_C			@C
noextra:
	tst gb_flg,#PSR_h					@half carry.
	orrne r0,r0,#0x06000000

	tst gb_flg,#PSR_C					@carry.
	orrne r0,r0,#0x60000000

	tst gb_flg,#PSR_n					@check if last instruction was add or sub.
	bne doSUBconv

doADDconv:
	and gb_flg,gb_flg,#PSR_C+PSR_n	@keep C & n
	adds gb_a,gb_a,r0
	orreq gb_flg,gb_flg,#PSR_Z
	cmp r1,#0x0A000000
	orrpl gb_flg,gb_flg,#PSR_h
	fetch 1

doSUBconv:
	and gb_flg,gb_flg,#PSR_C+PSR_n+PSR_h	@keep C & n & H
	subs gb_a,gb_a,r0
	orreq gb_flg,gb_flg,#PSR_Z
	cmp r1,#0x06000000
	bicpl gb_flg,gb_flg,#PSR_h
	fetch 1
@----------------------------------------------------------------------------
_28:		@	JR Z,*	jump if zero
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	bne _18
	add gb_pc, gb_pc, #0x00010000
	fetch 2
@----------------------------------------------------------------------------
_29:		@	ADD HL,HL
@----------------------------------------------------------------------------
	opADD16_HL
	fetch 2
@----------------------------------------------------------------------------
_2A:		@	LDI A,(HL)	load A from (HL), incr HL
@----------------------------------------------------------------------------
	readA16 gb_hl
	add gb_hl,gb_hl,#0x00010000
	fetch 2
@----------------------------------------------------------------------------
_2B:		@	DEC HL
@----------------------------------------------------------------------------
	opDEC16 gb_hl
	fetch 2
@----------------------------------------------------------------------------
_2C:		@	INC L
@----------------------------------------------------------------------------
	opINC8L gb_hl
	fetch 1
@----------------------------------------------------------------------------
_2D:		@	DEC L
@----------------------------------------------------------------------------
	opDEC8L gb_hl
	fetch 1
@----------------------------------------------------------------------------
_2E:		@	LD L,#nn
@----------------------------------------------------------------------------
	readPCByte
	and gb_hl, gb_hl, #0xFF000000
	orr gb_hl, gb_hl, r0, lsl#16
	fetch 2
@----------------------------------------------------------------------------
_2F:		@	CPL	complement A
@----------------------------------------------------------------------------
	eor gb_a,gb_a,#0xFF000000
	orr gb_flg,gb_flg,#PSR_n|PSR_h		@set n & h
	fetch 1
@----------------------------------------------------------------------------
_30:		@	JR NC,*	jump if no carry
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	beq _18
	add gb_pc, gb_pc, #0x00010000
	fetch 2
@----------------------------------------------------------------------------
_31:		@	LD SP,#nnnn
@----------------------------------------------------------------------------
	readPCWord
	mov r0,r0,lsl#16
	str r0, [gb_cpu,#SP]
	fetch 3	
@----------------------------------------------------------------------------
_32:		@	LDD (HL),A	write A to (HL), decr HL
@----------------------------------------------------------------------------
	writeA16 gb_hl
	sub gb_hl,gb_hl,#0x00010000
	fetch 2
@----------------------------------------------------------------------------
_33:		@	INC SP
@----------------------------------------------------------------------------
	ldr r0,[gb_cpu,#SP]
	opINC16 r0
	str r0,[gb_cpu,#SP]
	fetch 2
@----------------------------------------------------------------------------
_34:		@	INC (HL)
@----------------------------------------------------------------------------
	readmemHL
	opINC8b
	writememHL
	fetch 3
@----------------------------------------------------------------------------
_35:		@	DEC (HL)
@----------------------------------------------------------------------------
	readmemHL
	opDEC8b
	writememHL
	fetch 3
@----------------------------------------------------------------------------
_36:		@	LD (HL),#nn
@----------------------------------------------------------------------------
	readPCByte
	mov r1, r0
	writememHL
	fetch 3
@----------------------------------------------------------------------------
_37:		@	SCF	set carry flag
@----------------------------------------------------------------------------
	and gb_flg,gb_flg,#PSR_Z	@clear n & h, keep zero
	orr gb_flg,gb_flg,#PSR_C	@set carry.
	fetch 1
@----------------------------------------------------------------------------
_38:		@	JR C,*	jump if carry
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	bne _18
	add gb_pc, gb_pc, #0x00010000
	fetch 2
@----------------------------------------------------------------------------
_39:		@	ADD HL,SP
@----------------------------------------------------------------------------
	ldr r0,[gb_cpu,#SP]
	opADD16 r0
	fetch 2
@----------------------------------------------------------------------------
_3A:		@	LDD A,(HL)	load A from (HL), decr HL
@----------------------------------------------------------------------------
	readA16 gb_hl
	sub gb_hl,gb_hl,#0x00010000
	fetch 2
@----------------------------------------------------------------------------
_3B:		@	DEC SP
@----------------------------------------------------------------------------
	ldr r0,[gb_cpu,#SP]
	opDEC16 r0
	str r0,[gb_cpu,#SP]
	fetch 2
@----------------------------------------------------------------------------
_3C:		@	INC A
@----------------------------------------------------------------------------
	opINC8A
	fetch 1
@----------------------------------------------------------------------------
_3D:		@	DEC A
@----------------------------------------------------------------------------
	opDEC8A
	fetch 1
@----------------------------------------------------------------------------
_3E:		@	LD A,#nn
@----------------------------------------------------------------------------
	readPCByte
	mov gb_a, r0, lsl#24
	fetch 2
@----------------------------------------------------------------------------
_3F:		@	CCF	complement carry flag
@----------------------------------------------------------------------------
	and gb_flg,gb_flg,#PSR_Z|PSR_C	@clear n & h, keep zero & carry.
	eor gb_flg,gb_flg,#PSR_C	@complement carry.
	fetch 1
@----------------------------------------------------------------------------
@_40:		@	LD B,B
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_41:		@	LD B,C
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0x00FF0000
	orr gb_bc,gb_bc,gb_bc,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_42:		@	LD B,D
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0x00FF0000
	and r0,gb_de,#0xFF000000
	orr gb_bc,gb_bc,r0
	fetch 1
@----------------------------------------------------------------------------
_43:		@	LD B,E
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0x00FF0000
	orr gb_bc,gb_bc,gb_de,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_44:		@	LD B,H
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0x00FF0000
	and r0,gb_hl,#0xFF000000
	orr gb_bc,gb_bc,r0
	fetch 1
@----------------------------------------------------------------------------
_45:		@	LD B,L
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0x00FF0000
	orr gb_bc,gb_bc,gb_hl,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_46:		@	LD B,(HL)
@----------------------------------------------------------------------------
	readmemHL
	and gb_bc,gb_bc,#0x00FF0000
	orr gb_bc,gb_bc,r0,lsl#24
	fetch 2
@----------------------------------------------------------------------------
_47:		@	LD B,A
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0x00FF0000
	orr gb_bc,gb_bc,gb_a
	fetch 1
@----------------------------------------------------------------------------
_48:		@	LD C,B
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0xFF000000
	orr gb_bc,gb_bc,gb_bc,lsr#8
	fetch 1
@----------------------------------------------------------------------------
@_49:		@	LD C,C
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_4A:		@	LD C,D
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0xFF000000
	orr gb_bc,gb_bc,gb_de,lsr#8
	bic gb_bc,gb_bc,#0x0000FF00
	fetch 1
@----------------------------------------------------------------------------
_4B:		@	LD C,E
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0xFF000000
	and r0,gb_de,#0x00FF0000
	orr gb_bc,gb_bc,r0
	fetch 1
@----------------------------------------------------------------------------
_4C:		@	LD C,H
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0xFF000000
	orr gb_bc,gb_bc,gb_hl,lsr#8
	bic gb_bc,gb_bc,#0x0000FF00
	fetch 1
@----------------------------------------------------------------------------
_4D:		@	LD C,L
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0xFF000000
	and r0,gb_hl,#0x00FF0000
	orr gb_bc,gb_bc,r0
	fetch 1
@----------------------------------------------------------------------------
_4E:		@	LD C,(HL)
@----------------------------------------------------------------------------
	readmemHL
	and gb_bc,gb_bc,#0xFF000000
	orr gb_bc,gb_bc,r0,lsl#16
	fetch 2
@----------------------------------------------------------------------------
_4F:		@	LD C,A
@----------------------------------------------------------------------------
	and gb_bc,gb_bc,#0xFF000000
	orr gb_bc,gb_bc,gb_a,lsr#8
	fetch 1
@----------------------------------------------------------------------------
_50:		@	LD D,B
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0x00FF0000
	and r0,gb_bc,#0xFF000000
	orr gb_de,gb_de,r0
	fetch 1
@----------------------------------------------------------------------------
_51:		@	LD D,C
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0x00FF0000
	orr gb_de,gb_de,gb_bc,lsl#8
	fetch 1
@----------------------------------------------------------------------------
@_52:		@	LD D,D
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_53:		@	LD D,E
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0x00FF0000
	orr gb_de,gb_de,gb_de,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_54:		@	LD D,H
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0x00FF0000
	and r0,gb_hl,#0xFF000000
	orr gb_de,gb_de,r0
	fetch 1
@----------------------------------------------------------------------------
_55:		@	LD D,L
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0x00FF0000
	orr gb_de,gb_de,gb_hl,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_56:		@	LD D,(HL)
@----------------------------------------------------------------------------
	readmemHL
	and gb_de,gb_de,#0x00FF0000
	orr gb_de,gb_de,r0,lsl#24
	fetch 2
@----------------------------------------------------------------------------
_57:		@	LD D,A
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0x00FF0000
	orr gb_de,gb_de,gb_a
	fetch 1
@----------------------------------------------------------------------------
_58:		@	LD E,B
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0xFF000000
	orr gb_de,gb_de,gb_bc,lsr#8
	bic gb_de,gb_de,#0x0000FF00
	fetch 1
@----------------------------------------------------------------------------
_59:		@	LD E,C
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0xFF000000
	and r0,gb_bc,#0x00FF0000
	orr gb_de,gb_de,r0
	fetch 1
@----------------------------------------------------------------------------
_5A:		@	LD E,D
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0xFF000000
	orr gb_de,gb_de,gb_de,lsr#8
	fetch 1
@----------------------------------------------------------------------------
@_5B:		@	LD E,E
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_5C:		@	LD E,H
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0xFF000000
	orr gb_de,gb_de,gb_hl,lsr#8
	bic gb_de,gb_de,#0x0000FF00
	fetch 1
@----------------------------------------------------------------------------
_5D:		@	LD E,L
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0xFF000000
	and r0,gb_hl,#0x00FF0000
	orr gb_de,gb_de,r0
	fetch 1
@----------------------------------------------------------------------------
_5E:		@	LD E,(HL)
@----------------------------------------------------------------------------
	readmemHL
	and gb_de,gb_de,#0xFF000000
	orr gb_de,gb_de,r0,lsl#16
	fetch 2
@----------------------------------------------------------------------------
_5F:		@	LD E,A
@----------------------------------------------------------------------------
	and gb_de,gb_de,#0xFF000000
	orr gb_de,gb_de,gb_a,lsr#8
	fetch 1
@----------------------------------------------------------------------------
_60:		@	LD H,B
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0x00FF0000
	and r0,gb_bc,#0xFF000000
	orr gb_hl,gb_hl,r0
	fetch 1
@----------------------------------------------------------------------------
_61:		@	LD H,C
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0x00FF0000
	orr gb_hl,gb_hl,gb_bc,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_62:		@	LD H,D
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0x00FF0000
	and r0,gb_de,#0xFF000000
	orr gb_hl,gb_hl,r0
	fetch 1
@----------------------------------------------------------------------------
_63:		@	LD H,E
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0x00FF0000
	orr gb_hl,gb_hl,gb_de,lsl#8
	fetch 1
@----------------------------------------------------------------------------
@_64:		@	LD H,H
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_65:		@	LD H,L
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0x00FF0000
	orr gb_hl,gb_hl,gb_hl,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_66:		@	LD H,(HL)
@----------------------------------------------------------------------------
	readmemHL
	and gb_hl,gb_hl,#0x00FF0000
	orr gb_hl,gb_hl,r0,lsl#24
	fetch 2
@----------------------------------------------------------------------------
_67:		@	LD H,A
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0x00FF0000
	orr gb_hl,gb_hl,gb_a
	fetch 1
@----------------------------------------------------------------------------
_68:		@	LD L,B
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0xFF000000
	orr gb_hl,gb_hl,gb_bc,lsr#8
	bic gb_hl,gb_hl,#0x0000FF00
	fetch 1
@----------------------------------------------------------------------------
_69:		@	LD L,C
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0xFF000000
	and r0,gb_bc,#0x00FF0000
	orr gb_hl,gb_hl,r0
	fetch 1
@----------------------------------------------------------------------------
_6A:		@	LD L,D
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0xFF000000
	orr gb_hl,gb_hl,gb_de,lsr#8
	bic gb_hl,gb_hl,#0x0000FF00
	fetch 1
@----------------------------------------------------------------------------
_6B:		@	LD L,E
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0xFF000000
	and r0,gb_de,#0x00FF0000
	orr gb_hl,gb_hl,r0
	fetch 1
@----------------------------------------------------------------------------
_6C:		@	LD L,H
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0xFF000000
	orr gb_hl,gb_hl,gb_hl,lsr#8
	fetch 1
@----------------------------------------------------------------------------
@_6D:		@	LD L,L
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_6E:		@	LD L,(HL)
@----------------------------------------------------------------------------
	readmemHL
	and gb_hl,gb_hl,#0xFF000000
	orr gb_hl,gb_hl,r0,lsl#16
	fetch 2
@----------------------------------------------------------------------------
_6F:		@	LD L,A
@----------------------------------------------------------------------------
	and gb_hl,gb_hl,#0xFF000000
	orr gb_hl,gb_hl,gb_a,lsr#8
	fetch 1
@----------------------------------------------------------------------------
_70:		@	LD (HL),B
@----------------------------------------------------------------------------
	mov r1,gb_bc,lsr#24
	writememHL
	fetch 2
@----------------------------------------------------------------------------
_71:		@	LD (HL),C
@----------------------------------------------------------------------------
	mov r1,gb_bc,lsr#16
	and r1,r1,#0xFF
	writememHL
	fetch 2
@----------------------------------------------------------------------------
_72:		@	LD (HL),D
@----------------------------------------------------------------------------
	mov r1,gb_de,lsr#24
	writememHL
	fetch 2
@----------------------------------------------------------------------------
_73:		@	LD (HL),E
@----------------------------------------------------------------------------
	mov r1,gb_de,lsr#16
	and r1,r1,#0xFF
	writememHL
	fetch 2
@----------------------------------------------------------------------------
_74:		@	LD (HL),H
@----------------------------------------------------------------------------
	mov r1,gb_hl,lsr#24
	writememHL
	fetch 2
@----------------------------------------------------------------------------
_75:		@	LD (HL),L		special...ETHOS
@----------------------------------------------------------------------------
	mov r1,gb_hl,lsr#16
	and r1,r1,#0xFF
	writememHL
	fetch 2
@----------------------------------------------------------------------------
_76:		@	HALT, wait for interrupt.
@----------------------------------------------------------------------------
	mov r0, #1
	strb r0, [gb_cpu,#halt]
	fetch 1
@----------------------------------------------------------------------------
_77:		@	LD (HL),A
@----------------------------------------------------------------------------
	writeA16 gb_hl
	fetch 2
@----------------------------------------------------------------------------
_78:		@	LD A,B
@----------------------------------------------------------------------------
	and gb_a,gb_bc,#0xFF000000
	fetch 1
@----------------------------------------------------------------------------
_79:		@	LD A,C
@----------------------------------------------------------------------------
	mov gb_a,gb_bc,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_7A:		@	LD A,D
@----------------------------------------------------------------------------
	and gb_a,gb_de,#0xFF000000
	fetch 1
@----------------------------------------------------------------------------
_7B:		@	LD A,E
@----------------------------------------------------------------------------
	mov gb_a,gb_de,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_7C:		@	LD A,H
@----------------------------------------------------------------------------
	and gb_a,gb_hl,#0xFF000000
	fetch 1
@----------------------------------------------------------------------------
_7D:		@	LD A,L
@----------------------------------------------------------------------------
	mov gb_a,gb_hl,lsl#8
	fetch 1
@----------------------------------------------------------------------------
_7E:		@	LD A,(HL)
@----------------------------------------------------------------------------
	readA16 gb_hl
	fetch 2
@----------------------------------------------------------------------------
@_7F:		@	LD A,A
@----------------------------------------------------------------------------
@	fetch 1
@----------------------------------------------------------------------------
_80:		@	ADD B
@----------------------------------------------------------------------------
	opADDH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_81:		@	ADD C
@----------------------------------------------------------------------------
	opADDL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_82:		@	ADD D
@----------------------------------------------------------------------------
	opADDH gb_de
	fetch 1
@----------------------------------------------------------------------------
_83:		@	ADD E
@----------------------------------------------------------------------------
	opADDL gb_de
	fetch 1
@----------------------------------------------------------------------------
_84:		@	ADD H
@----------------------------------------------------------------------------
	opADDH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_85:		@	ADD L
@----------------------------------------------------------------------------
	opADDL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_86:		@	ADD (HL)
@----------------------------------------------------------------------------
	readmemHL
	opADDb
	fetch 2
@----------------------------------------------------------------------------
_87:		@	ADD A
@----------------------------------------------------------------------------
	opADDA
	fetch 1
@----------------------------------------------------------------------------
_88:		@	ADC B
@----------------------------------------------------------------------------
	opADCH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_89:		@	ADC C
@----------------------------------------------------------------------------
	opADCL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_8A:		@	ADC D
@----------------------------------------------------------------------------
	opADCH gb_de
	fetch 1
@----------------------------------------------------------------------------
_8B:		@	ADC E
@----------------------------------------------------------------------------
	opADCL gb_de
	fetch 1
@----------------------------------------------------------------------------
_8C:		@	ADC H
@----------------------------------------------------------------------------
	opADCH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_8D:		@	ADC L
@----------------------------------------------------------------------------
	opADCL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_8E:		@	ADC (HL)
@----------------------------------------------------------------------------
	readmemHL
	opADCb
	fetch 2
@----------------------------------------------------------------------------
_8F:		@	ADC A
@----------------------------------------------------------------------------
	opADCA
	fetch 1
@----------------------------------------------------------------------------
_90:		@	SUB B
@----------------------------------------------------------------------------
	opSUBH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_91:		@	SUB C
@----------------------------------------------------------------------------
	opSUBL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_92:		@	SUB D
@----------------------------------------------------------------------------
	opSUBH gb_de
	fetch 1
@----------------------------------------------------------------------------
_93:		@	SUB E
@----------------------------------------------------------------------------
	opSUBL gb_de
	fetch 1
@----------------------------------------------------------------------------
_94:		@	SUB H
@----------------------------------------------------------------------------
	opSUBH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_95:		@	SUB L
@----------------------------------------------------------------------------
	opSUBL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_96:		@	SUB (HL)
@----------------------------------------------------------------------------
	readmemHL
	opSUBb
	fetch 2
@----------------------------------------------------------------------------
_97:		@	SUB A
@----------------------------------------------------------------------------
	opSUBA
	fetch 1
@----------------------------------------------------------------------------
_98:		@	SBC B
@----------------------------------------------------------------------------
	opSBCH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_99:		@	SBC C
@----------------------------------------------------------------------------
	opSBCL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_9A:		@	SBC D
@----------------------------------------------------------------------------
	opSBCH gb_de
	fetch 1
@----------------------------------------------------------------------------
_9B:		@	SBC E
@----------------------------------------------------------------------------
	opSBCL gb_de
	fetch 1
@----------------------------------------------------------------------------
_9C:		@	SBC H
@----------------------------------------------------------------------------
	opSBCH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_9D:		@	SBC L
@----------------------------------------------------------------------------
	opSBCL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_9E:		@	SBC (HL)
@----------------------------------------------------------------------------
	readmemHL
	opSBCb
	fetch 2
@----------------------------------------------------------------------------
_9F:		@	SBC A
@----------------------------------------------------------------------------
	opSBCA
	fetch 1
@----------------------------------------------------------------------------
_A0:		@	AND B
@----------------------------------------------------------------------------
	opANDH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_A1:		@	AND C
@----------------------------------------------------------------------------
	opANDL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_A2:		@	AND D
@----------------------------------------------------------------------------
	opANDH gb_de
	fetch 1
@----------------------------------------------------------------------------
_A3:		@	AND E
@----------------------------------------------------------------------------
	opANDL gb_de
	fetch 1
@----------------------------------------------------------------------------
_A4:		@	AND H
@----------------------------------------------------------------------------
	opANDH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_A5:		@	AND L
@----------------------------------------------------------------------------
	opANDL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_A6:		@	AND (HL)
@----------------------------------------------------------------------------
	readmemHL
	opANDb
	fetch 2
@----------------------------------------------------------------------------
_A7:		@	AND A
@----------------------------------------------------------------------------
	opANDA
	fetch 1
@----------------------------------------------------------------------------
_A8:		@	XOR B
@----------------------------------------------------------------------------
	opXORH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_A9:		@	XOR C
@----------------------------------------------------------------------------
	opXORL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_AA:		@	XOR D
@----------------------------------------------------------------------------
	opXORH gb_de
	fetch 1
@----------------------------------------------------------------------------
_AB:		@	XOR E
@----------------------------------------------------------------------------
	opXORL gb_de
	fetch 1
@----------------------------------------------------------------------------
_AC:		@	XOR H
@----------------------------------------------------------------------------
	opXORH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_AD:		@	XOR L
@----------------------------------------------------------------------------
	opXORL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_AE:		@	XOR (HL)
@----------------------------------------------------------------------------
	readmemHL
	opXORb
	fetch 2
@----------------------------------------------------------------------------
_AF:		@	XOR A
@----------------------------------------------------------------------------
	opXORA
	fetch 1
@----------------------------------------------------------------------------
_B0:		@	OR B
@----------------------------------------------------------------------------
	opORH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_B1:		@	OR C
@----------------------------------------------------------------------------
	opORL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_B2:		@	OR D
@----------------------------------------------------------------------------
	opORH gb_de
	fetch 1
@----------------------------------------------------------------------------
_B3:		@	OR E
@----------------------------------------------------------------------------
	opORL gb_de
	fetch 1
@----------------------------------------------------------------------------
_B4:		@	OR H
@----------------------------------------------------------------------------
	opORH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_B5:		@	OR L
@----------------------------------------------------------------------------
	opORL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_B6:		@	OR (HL)
@----------------------------------------------------------------------------
	readmemHL
	opORb
	fetch 2
@----------------------------------------------------------------------------
_B7:		@	OR A
@----------------------------------------------------------------------------
	opORA
	fetch 1
@----------------------------------------------------------------------------
_B8:		@	CP B
@----------------------------------------------------------------------------
	opCPH gb_bc
	fetch 1
@----------------------------------------------------------------------------
_B9:		@	CP C
@----------------------------------------------------------------------------
	opCPL gb_bc
	fetch 1
@----------------------------------------------------------------------------
_BA:		@	CP D
@----------------------------------------------------------------------------
	opCPH gb_de
	fetch 1
@----------------------------------------------------------------------------
_BB:		@	CP E
@----------------------------------------------------------------------------
	opCPL gb_de
	fetch 1
@----------------------------------------------------------------------------
_BC:		@	CP H
@----------------------------------------------------------------------------
	opCPH gb_hl
	fetch 1
@----------------------------------------------------------------------------
_BD:		@	CP L
@----------------------------------------------------------------------------
	opCPL gb_hl
	fetch 1
@----------------------------------------------------------------------------
_BE:		@	CP (HL)
@----------------------------------------------------------------------------
	readmemHL
	opCPb
	fetch 2
@----------------------------------------------------------------------------
_BF:		@	CP A
@----------------------------------------------------------------------------
	opCPA
	fetch 1
@----------------------------------------------------------------------------
_C0:		@	RET NZ
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	beq _C9
	fetch 2
@----------------------------------------------------------------------------
_C1:		@	POP BC
@----------------------------------------------------------------------------
	opPOP
	mov gb_bc,r0,lsl#16
	fetch 3
@----------------------------------------------------------------------------
_C2:		@	JP NZ,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	beq _C3
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_C3:		@	JP $nnnn
@----------------------------------------------------------------------------
	mov r0,gb_pc,lsr#16
	readw
	mov gb_pc,r0,lsl#16
	fetch 4
@----------------------------------------------------------------------------
_C4:		@	CALL NZ,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	beq _CD
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_C5:		@	PUSH BC
@----------------------------------------------------------------------------
	mov r1,gb_bc,lsr#16
	opPUSH
	fetch 4
@----------------------------------------------------------------------------
_C6:		@	ADD #nn
@----------------------------------------------------------------------------
	readPCByte
	opADDb
	fetch 2
@----------------------------------------------------------------------------
_C7:		@	RST 0x00
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0
	fetch 4
@----------------------------------------------------------------------------
_CF:		@	RST 0x08
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00080000
	fetch 4
@----------------------------------------------------------------------------
_D7:		@	RST 0x10
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00100000
	fetch 4
@----------------------------------------------------------------------------
_DF:		@	RST 0x18
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00180000
	fetch 4
@----------------------------------------------------------------------------
_E7:		@	RST 0x20
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00200000
	fetch 4
@----------------------------------------------------------------------------
_EF:		@	RST 0x28
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00280000
	fetch 4
@----------------------------------------------------------------------------
_F7:		@	RST 0x30
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00300000
	fetch 4
@----------------------------------------------------------------------------
_FF:		@	RST 0x38
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	opPUSH
	mov gb_pc, #0x00380000
	fetch 4
@----------------------------------------------------------------------------
_C8:		@	RET Z
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	bne _C9
	fetch 2
@----------------------------------------------------------------------------
_C9:		@	RET
@---------------------------------------------------------------------------- 
	opPOP
	mov gb_pc, r0, lsl#16
	fetch 4
@----------------------------------------------------------------------------
_CA:		@	JP Z,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	bne _C3
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_CC:		@	CALL Z,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_Z
	bne _CD
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_CD:		@	CALL $nnnn
@----------------------------------------------------------------------------
	mov r1, gb_pc, lsr#16
	add r1, r1, #2
	opPUSH
	mov r0,gb_pc,lsr#16
	readw
	mov gb_pc,r0,lsl#16
	fetch 6
@----------------------------------------------------------------------------
_CE:		@	ADC #nn
@----------------------------------------------------------------------------
	readPCByte
	opADCb
	fetch 2
@----------------------------------------------------------------------------
_D0:		@	RET NC
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	beq _C9
	fetch 2
@----------------------------------------------------------------------------
_D1:		@	POP DE
@----------------------------------------------------------------------------
	opPOP
	mov gb_de,r0,lsl#16
	fetch 3
@----------------------------------------------------------------------------
_D2:		@	JP NC,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	beq _C3
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_D4:		@	CALL NC,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	beq _CD
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_D5:		@	PUSH DE
@----------------------------------------------------------------------------
	mov r1,gb_de,lsr#16
	opPUSH
	fetch 4
@----------------------------------------------------------------------------
_D6:		@	SUB #nn
@----------------------------------------------------------------------------
	readPCByte
	opSUBb
	fetch 2
@----------------------------------------------------------------------------
_D8:		@	RET C
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	bne _C9
	fetch 2
@----------------------------------------------------------------------------
_D9:		@	RETI, return and enable interrupt
@----------------------------------------------------------------------------
	opPOP
	mov gb_pc, r0, lsl#16  
	mov r0, #1
	strb r0, [gb_cpu,#IME]
	strb r0, [gb_cpu,#IMA]
	fetch 4
@----------------------------------------------------------------------------
_DA:		@	JP C,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	bne _C3
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_DC:		@	CALL C,$nnnn
@----------------------------------------------------------------------------
	tst gb_flg,#PSR_C
	bne _CD
	add gb_pc, gb_pc, #0x00020000
	fetch 3
@----------------------------------------------------------------------------
_DE:		@	SBC #nn
@----------------------------------------------------------------------------
	readPCByte
	opSBCb
	fetch 2
@----------------------------------------------------------------------------
_E0:		@	LD ($FF00+nn),A
@----------------------------------------------------------------------------
	readPCByte
	orr r0, r0, #0xFF00
	mov r1, gb_a, lsr#24	
	writeb
	fetch 3
@----------------------------------------------------------------------------
_E1:		@	POP HL
@----------------------------------------------------------------------------
	opPOP
	mov gb_hl,r0,lsl#16
	fetch 3
@----------------------------------------------------------------------------
_E2:		@	LD ($FF00+C),A
@----------------------------------------------------------------------------
	mov r0, gb_bc, lsr#16 
	orr r0, r0, #0xFF00
	mov r1, gb_a, lsr#24	
	writeb
	fetch 2
@----------------------------------------------------------------------------
_E5:		@	PUSH HL
@----------------------------------------------------------------------------
	mov r1,gb_hl,lsr#16
	opPUSH
	fetch 4
@----------------------------------------------------------------------------
_E6:		@	AND #nn
@----------------------------------------------------------------------------
	readPCByte
	opANDb
	fetch 2
@----------------------------------------------------------------------------
_E8:		@	ADD SP,dd
@----------------------------------------------------------------------------
	readPCSigned
	ldr r2,[gb_cpu, #SP]
	eor r1,r2,r0,lsl#16		@prepare for h check.
	adds r2,r2,r0,lsl#16
	str r2,[gb_cpu, #SP]
	eor gb_flg,r1,r2
	and gb_flg,gb_flg,#PSR_h
	orrcs gb_flg,gb_flg,#PSR_C
	fetch 3
@----------------------------------------------------------------------------
_E9:		@	JP HL
@----------------------------------------------------------------------------
	mov gb_pc,gb_hl
	fetch 1
@----------------------------------------------------------------------------
_EA:		@	LD (nnnn),A	write A to (nnnn)
@----------------------------------------------------------------------------
	readPCWord
	mov r1,gb_a,lsr#24
	writeb
	fetch 4
@----------------------------------------------------------------------------
_EE:		@	XOR #nn
@----------------------------------------------------------------------------
	readPCByte
	opXORb
	fetch 2
@----------------------------------------------------------------------------
_F0:		@	LD A,($FF00+nn)
@----------------------------------------------------------------------------
	readPCByte
	orr r0, r0, #0xFF00
	readb
	mov gb_a,r0,lsl#24
	fetch 3
@----------------------------------------------------------------------------
_F1:		@	POP AF
@----------------------------------------------------------------------------
	opPOP
	and r1, r0, #0xFF00
	mov gb_a, r1, lsl#16
	decodeFLG
	fetch 3
@----------------------------------------------------------------------------
_F2:		@	LD A,($FF00+C)
@----------------------------------------------------------------------------
	mov r0, gb_bc, lsr#16
	orr r0, r0, #0xFF00
	readb
	mov gb_a,r0,lsl#24
	fetch 2
@----------------------------------------------------------------------------
_F3:		@	DI, disable interrupt
@----------------------------------------------------------------------------
	mov r0, #0
	strb r0, [gb_cpu,#halt]
	strb r0, [gb_cpu,#IMA]
	strb r0, [gb_cpu,#IME]
	fetch 1
@----------------------------------------------------------------------------
_F5:		@	PUSH AF
@----------------------------------------------------------------------------
	encodeFLG
	orr r1,r0,gb_a,lsr#16
	opPUSH
	fetch 4
@----------------------------------------------------------------------------
_F6:		@	OR #nn
@----------------------------------------------------------------------------
	readPCByte
	opORb
	fetch 2
@----------------------------------------------------------------------------
_F8:		@	LD HL,SP+dd
@----------------------------------------------------------------------------
	readPCSigned
	ldr r2,[gb_cpu,#SP]
	eor r1,r2,r0,lsl#16
	adds gb_hl,r2,r0,lsl#16
	eor gb_flg,r1,gb_hl
	and gb_flg,gb_flg,#PSR_h
	orrcs gb_flg,gb_flg,#PSR_C
	fetch 3
@----------------------------------------------------------------------------
_F9:		@	LD SP,HL
@----------------------------------------------------------------------------
	str gb_hl,[gb_cpu,#SP]
	fetch 2
@----------------------------------------------------------------------------
_FA:		@	LD A,(nnnn)	load A from (nnnn)
@----------------------------------------------------------------------------
	readPCWord
	readb
	mov gb_a,r0,lsl#24
	fetch 4
@----------------------------------------------------------------------------
_FB:		@	EI, enable interrupt
@----------------------------------------------------------------------------
	mov r0, #1
	strb r0, [gb_cpu,#IMA]
	fetch 1
@------------------------------------------------------------------------------
_FE:		@	CP #nn
@------------------------------------------------------------------------------
	readPCByte
	opCPb
	fetch 2
@------------------------------------------------------------------------------
_CB:		@	Extensions
@------------------------------------------------------------------------------
	/*TO BE IMPLEMENTED*/
	readPCByte
	
	ldr r1, cb_j_addr
	ldr r1, [r1,r0,lsl#2]
	bx r1
cb_j_addr:
	.word cb_table

@----------------------------------------------------------------------------
_CB00:		@	RLC B
@----------------------------------------------------------------------------
	opRLCH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB01:		@	RLC C
@----------------------------------------------------------------------------
	opRLCL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB02:		@	RLC D
@----------------------------------------------------------------------------
	opRLCH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB03:		@	RLC E
@----------------------------------------------------------------------------
	opRLCL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB04:		@	RLC H
@----------------------------------------------------------------------------
	opRLCH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB05:		@	RLC L
@----------------------------------------------------------------------------
	opRLCL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB06:		@	RLC (HL)
@----------------------------------------------------------------------------
	readmemHL
	opRLCb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB07:		@	RLC A
@----------------------------------------------------------------------------
	opRLC gb_a
	fetch 2
@----------------------------------------------------------------------------
_CB08:		@	RRC B
@----------------------------------------------------------------------------
	opRRCH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB09:		@	RRC C
@----------------------------------------------------------------------------
	opRRCL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB0A:		@	RRC D
@----------------------------------------------------------------------------
	opRRCH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB0B:		@	RRC E
@----------------------------------------------------------------------------
	opRRCL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB0C:		@	RRC H
@----------------------------------------------------------------------------
	opRRCH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB0D:		@	RRC L
@----------------------------------------------------------------------------
	opRRCL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB0E:		@	RRC (HL)
@----------------------------------------------------------------------------
	readmemHL
	opRRCb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB0F:		@	RRC A
@----------------------------------------------------------------------------
	opRRC gb_a,25
	mov gb_a,gb_a,lsl#24
	fetch 2
@----------------------------------------------------------------------------
_CB10:		@	RL B
@----------------------------------------------------------------------------
	opRLH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB11:		@	RL C
@----------------------------------------------------------------------------
	opRLL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB12:		@	RL D
@----------------------------------------------------------------------------
	opRLH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB13:		@	RL E
@----------------------------------------------------------------------------
	opRLL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB14:		@	RL H
@----------------------------------------------------------------------------
	opRLH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB15:		@	RL L
@----------------------------------------------------------------------------
	opRLL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB16:		@	RL (HL)
@----------------------------------------------------------------------------
	readmemHL
	opRLb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB17:		@	RL A
@----------------------------------------------------------------------------
	opRL gb_a
	fetch 2
@----------------------------------------------------------------------------
_CB18:		@	RR B
@----------------------------------------------------------------------------
	opRRH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB19:		@	RR C
@----------------------------------------------------------------------------
	opRRL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB1A:		@	RR D
@----------------------------------------------------------------------------
	opRRH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB1B:		@	RR E
@----------------------------------------------------------------------------
	opRRL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB1C:		@	RR H
@----------------------------------------------------------------------------
	opRRH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB1D:		@	RR L
@----------------------------------------------------------------------------
	opRRL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB1E:		@	RR (HL)
@----------------------------------------------------------------------------
	readmemHL
	opRRb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB1F:		@	RR A
@----------------------------------------------------------------------------
	opRR gb_a
	fetch 2
@----------------------------------------------------------------------------
_CB20:		@	SLA B
@----------------------------------------------------------------------------
	opSLAH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB21:		@	SLA C
@----------------------------------------------------------------------------
	opSLAL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB22:		@	SLA D
@----------------------------------------------------------------------------
	opSLAH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB23:		@	SLA E
@----------------------------------------------------------------------------
	opSLAL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB24:		@	SLA H
@----------------------------------------------------------------------------
	opSLAH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB25:		@	SLA L
@----------------------------------------------------------------------------
	opSLAL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB26:		@	SLA (HL)
@----------------------------------------------------------------------------
	readmemHL
	opSLAb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB27:		@	SLA A
@----------------------------------------------------------------------------
	opSLAA
	fetch 2
@----------------------------------------------------------------------------
_CB28:		@	SRA B
@----------------------------------------------------------------------------
	opSRAH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB29:		@	SRA C
@----------------------------------------------------------------------------
	opSRAL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB2A:		@	SRA D
@----------------------------------------------------------------------------
	opSRAH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB2B:		@	SRA E
@----------------------------------------------------------------------------
	opSRAL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB2C:		@	SRA H
@----------------------------------------------------------------------------
	opSRAH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB2D:		@	SRA L
@----------------------------------------------------------------------------
	opSRAL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB2E:		@	SRA (HL)
@----------------------------------------------------------------------------
	readmemHL
	opSRAb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB2F:		@	SRA A
@----------------------------------------------------------------------------
	opSRAA
	fetch 2
@----------------------------------------------------------------------------
_CB30:		@	SWAP B
@----------------------------------------------------------------------------
	opSWAPH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB31:		@	SWAP C
@----------------------------------------------------------------------------
	opSWAPL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB32:		@	SWAP D
@----------------------------------------------------------------------------
	opSWAPH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB33:		@	SWAP E
@----------------------------------------------------------------------------
	opSWAPL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB34:		@	SWAP H
@----------------------------------------------------------------------------
	opSWAPH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB35:		@	SWAP L
@----------------------------------------------------------------------------
	opSWAPL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB36:		@	SWAP (HL)
@----------------------------------------------------------------------------
	readmemHL
	opSWAPb
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB37:		@	SWAP A
@----------------------------------------------------------------------------
	opSWAPA
	fetch 2
@----------------------------------------------------------------------------
_CB38:		@	SRL B
@----------------------------------------------------------------------------
	opSRLH gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB39:		@	SRL C
@----------------------------------------------------------------------------
	opSRLL gb_bc
	fetch 2
@----------------------------------------------------------------------------
_CB3A:		@	SRL D
@----------------------------------------------------------------------------
	opSRLH gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB3B:		@	SRL E
@----------------------------------------------------------------------------
	opSRLL gb_de
	fetch 2
@----------------------------------------------------------------------------
_CB3C:		@	SRL H
@----------------------------------------------------------------------------
	opSRLH gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB3D:		@	SRL L
@----------------------------------------------------------------------------
	opSRLL gb_hl
	fetch 2
@----------------------------------------------------------------------------
_CB3E:		@	SRL (HL)
@----------------------------------------------------------------------------
	readmemHL
	opSRLx r0,r1,1
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB3F:		@	SRL A
@----------------------------------------------------------------------------
	opSRLA
	fetch 2
@----------------------------------------------------------------------------
_CB40:		@	BIT 0,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 0
	fetch 2
@----------------------------------------------------------------------------
_CB41:		@	BIT 0,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 0
	fetch 2
@----------------------------------------------------------------------------
_CB42:		@	BIT 0,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 0
	fetch 2
@----------------------------------------------------------------------------
_CB43:		@	BIT 0,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 0
	fetch 2
@----------------------------------------------------------------------------
_CB44:		@	BIT 0,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 0
	fetch 2
@----------------------------------------------------------------------------
_CB45:		@	BIT 0,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 0
	fetch 2
@----------------------------------------------------------------------------
_CB46:		@	BIT 0,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 0
	fetch 3
@----------------------------------------------------------------------------
_CB47:		@	BIT 0,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 0
	fetch 2
@----------------------------------------------------------------------------
_CB48:		@	BIT 1,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 1
	fetch 2
@----------------------------------------------------------------------------
_CB49:		@	BIT 1,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 1
	fetch 2
@----------------------------------------------------------------------------
_CB4A:		@	BIT 1,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 1
	fetch 2
@----------------------------------------------------------------------------
_CB4B:		@	BIT 1,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 1
	fetch 2
@----------------------------------------------------------------------------
_CB4C:		@	BIT 1,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 1
	fetch 2
@----------------------------------------------------------------------------
_CB4D:		@	BIT 1,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 1
	fetch 2
@----------------------------------------------------------------------------
_CB4E:		@	BIT 1,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 1
	fetch 3
@----------------------------------------------------------------------------
_CB4F:		@	BIT 1,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 1
	fetch 2
@----------------------------------------------------------------------------
_CB50:		@	BIT 2,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 2
	fetch 2
@----------------------------------------------------------------------------
_CB51:		@	BIT 2,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 2
	fetch 2
@----------------------------------------------------------------------------
_CB52:		@	BIT 2,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 2
	fetch 2
@----------------------------------------------------------------------------
_CB53:		@	BIT 2,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 2
	fetch 2
@----------------------------------------------------------------------------
_CB54:		@	BIT 2,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 2
	fetch 2
@----------------------------------------------------------------------------
_CB55:		@	BIT 2,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 2
	fetch 2
@----------------------------------------------------------------------------
_CB56:		@	BIT 2,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 2
	fetch 3
@----------------------------------------------------------------------------
_CB57:		@	BIT 2,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 2
	fetch 2
@----------------------------------------------------------------------------
_CB58:		@	BIT 3,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 3
	fetch 2
@----------------------------------------------------------------------------
_CB59:		@	BIT 3,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 3
	fetch 2
@----------------------------------------------------------------------------
_CB5A:		@	BIT 3,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 3
	fetch 2
@----------------------------------------------------------------------------
_CB5B:		@	BIT 3,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 3
	fetch 2
@----------------------------------------------------------------------------
_CB5C:		@	BIT 3,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 3
	fetch 2
@----------------------------------------------------------------------------
_CB5D:		@	BIT 3,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 3
	fetch 2
@----------------------------------------------------------------------------
_CB5E:		@	BIT 3,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 3
	fetch 3
@----------------------------------------------------------------------------
_CB5F:		@	BIT 3,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 3
	fetch 2
@----------------------------------------------------------------------------
_CB60:		@	BIT 4,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 4
	fetch 2
@----------------------------------------------------------------------------
_CB61:		@	BIT 4,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 4
	fetch 2
@----------------------------------------------------------------------------
_CB62:		@	BIT 4,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 4
	fetch 2
@----------------------------------------------------------------------------
_CB63:		@	BIT 4,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 4
	fetch 2
@----------------------------------------------------------------------------
_CB64:		@	BIT 4,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 4
	fetch 2
@----------------------------------------------------------------------------
_CB65:		@	BIT 4,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 4
	fetch 2
@----------------------------------------------------------------------------
_CB66:		@	BIT 4,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 4
	fetch 3
@----------------------------------------------------------------------------
_CB67:		@	BIT 4,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 4
	fetch 2
@----------------------------------------------------------------------------
_CB68:		@	BIT 5,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 5
	fetch 2
@----------------------------------------------------------------------------
_CB69:		@	BIT 5,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 5
	fetch 2
@----------------------------------------------------------------------------
_CB6A:		@	BIT 5,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 5
	fetch 2
@----------------------------------------------------------------------------
_CB6B:		@	BIT 5,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 5
	fetch 2
@----------------------------------------------------------------------------
_CB6C:		@	BIT 5,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 5
	fetch 2
@----------------------------------------------------------------------------
_CB6D:		@	BIT 5,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 5
	fetch 2
@----------------------------------------------------------------------------
_CB6E:		@	BIT 5,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 5
	fetch 3
@----------------------------------------------------------------------------
_CB6F:		@	BIT 5,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 5
	fetch 2
@----------------------------------------------------------------------------
_CB70:		@	BIT 6,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 6
	fetch 2
@----------------------------------------------------------------------------
_CB71:		@	BIT 6,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 6
	fetch 2
@----------------------------------------------------------------------------
_CB72:		@	BIT 6,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 6
	fetch 2
@----------------------------------------------------------------------------
_CB73:		@	BIT 6,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 6
	fetch 2
@----------------------------------------------------------------------------
_CB74:		@	BIT 6,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 6
	fetch 2
@----------------------------------------------------------------------------
_CB75:		@	BIT 6,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 6
	fetch 2
@----------------------------------------------------------------------------
_CB76:		@	BIT 6,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 6
	fetch 3
@----------------------------------------------------------------------------
_CB77:		@	BIT 6,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 6
	fetch 2	
@----------------------------------------------------------------------------
_CB78:		@	BIT 7,B		
@----------------------------------------------------------------------------
	opBITH gb_bc, 7
	fetch 2
@----------------------------------------------------------------------------
_CB79:		@	BIT 7,C		
@----------------------------------------------------------------------------
	opBITL gb_bc, 7
	fetch 2
@----------------------------------------------------------------------------
_CB7A:		@	BIT 7,D		
@----------------------------------------------------------------------------
	opBITH gb_de, 7
	fetch 2
@----------------------------------------------------------------------------
_CB7B:		@	BIT 7,E		
@----------------------------------------------------------------------------
	opBITL gb_de, 7
	fetch 2
@----------------------------------------------------------------------------
_CB7C:		@	BIT 7,H		
@----------------------------------------------------------------------------
	opBITH gb_hl, 7
	fetch 2
@----------------------------------------------------------------------------
_CB7D:		@	BIT 7,L		
@----------------------------------------------------------------------------
	opBITL gb_hl, 7
	fetch 2
@----------------------------------------------------------------------------
_CB7E:		@	BIT 7,(HL)	
@------------------------------------------------------------------------------
	readmemHL
	opBITb r0, 7
	fetch 3
@----------------------------------------------------------------------------
_CB7F:		@	BIT 7,A		
@----------------------------------------------------------------------------
	opBITH gb_a, 7
	fetch 2		
@----------------------------------------------------------------------------
_CB80:		@	RES 0,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 0
	fetch 2
@----------------------------------------------------------------------------
_CB81:		@	RES 0,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 0
	fetch 2
@----------------------------------------------------------------------------
_CB82:		@	RES 0,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 0
	fetch 2
@----------------------------------------------------------------------------
_CB83:		@	RES 0,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 0
	fetch 2
@----------------------------------------------------------------------------
_CB84:		@	RES 0,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 0
	fetch 2
@----------------------------------------------------------------------------
_CB85:		@	RES 0,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 0
	fetch 2
@----------------------------------------------------------------------------
_CB86:		@	RES 0,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 0
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB87:		@	RES 0,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 0
	fetch 2
@----------------------------------------------------------------------------
_CB88:		@	RES 1,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 1
	fetch 2
@----------------------------------------------------------------------------
_CB89:		@	RES 1,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 1
	fetch 2
@----------------------------------------------------------------------------
_CB8A:		@	RES 1,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 1
	fetch 2
@----------------------------------------------------------------------------
_CB8B:		@	RES 1,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 1
	fetch 2
@----------------------------------------------------------------------------
_CB8C:		@	RES 1,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 1
	fetch 2
@----------------------------------------------------------------------------
_CB8D:		@	RES 1,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 1
	fetch 2
@----------------------------------------------------------------------------
_CB8E:		@	RES 1,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 1
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB8F:		@	RES 1,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 1
	fetch 2
@----------------------------------------------------------------------------
_CB90:		@	RES 2,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 2
	fetch 2
@----------------------------------------------------------------------------
_CB91:		@	RES 2,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 2
	fetch 2
@----------------------------------------------------------------------------
_CB92:		@	RES 2,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 2
	fetch 2
@----------------------------------------------------------------------------
_CB93:		@	RES 2,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 2
	fetch 2
@----------------------------------------------------------------------------
_CB94:		@	RES 2,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 2
	fetch 2
@----------------------------------------------------------------------------
_CB95:		@	RES 2,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 2
	fetch 2
@----------------------------------------------------------------------------
_CB96:		@	RES 2,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 2
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB97:		@	RES 2,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 2 
	fetch 2	
@----------------------------------------------------------------------------
_CB98:		@	RES 3,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 3
	fetch 2
@----------------------------------------------------------------------------
_CB99:		@	RES 3,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 3
	fetch 2
@----------------------------------------------------------------------------
_CB9A:		@	RES 3,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 3
	fetch 2
@----------------------------------------------------------------------------
_CB9B:		@	RES 3,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 3
	fetch 2
@----------------------------------------------------------------------------
_CB9C:		@	RES 3,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 3
	fetch 2
@----------------------------------------------------------------------------
_CB9D:		@	RES 3,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 3
	fetch 2
@----------------------------------------------------------------------------
_CB9E:		@	RES 3,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 3
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CB9F:		@	RES 3,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 3
	fetch 2
@----------------------------------------------------------------------------
_CBA0:		@	RES 4,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA1:		@	RES 4,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA2:		@	RES 4,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA3:		@	RES 4,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA4:		@	RES 4,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA5:		@	RES 4,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA6:		@	RES 4,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 4
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBA7:		@	RES 4,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 4
	fetch 2
@----------------------------------------------------------------------------
_CBA8:		@	RES 5,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 5
	fetch 2
@----------------------------------------------------------------------------
_CBA9:		@	RES 5,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 5
	fetch 2
@----------------------------------------------------------------------------
_CBAA:		@	RES 5,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 5
	fetch 2
@----------------------------------------------------------------------------
_CBAB:		@	RES 5,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 5
	fetch 2
@----------------------------------------------------------------------------
_CBAC:		@	RES 5,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 5
	fetch 2
@----------------------------------------------------------------------------
_CBAD:		@	RES 5,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 5
	fetch 2
@----------------------------------------------------------------------------
_CBAE:		@	RES 5,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 5
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBAF:		@	RES 5,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 5
	fetch 2
@----------------------------------------------------------------------------
_CBB0:		@	RES 6,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB1:		@	RES 6,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB2:		@	RES 6,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB3:		@	RES 6,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB4:		@	RES 6,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB5:		@	RES 6,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB6:		@	RES 6,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 6
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBB7:		@	RES 6,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 6
	fetch 2
@----------------------------------------------------------------------------
_CBB8:		@	RES 7,B		
@----------------------------------------------------------------------------
	opRESH gb_bc, 7
	fetch 2
@----------------------------------------------------------------------------
_CBB9:		@	RES 7,C		
@----------------------------------------------------------------------------
	opRESL gb_bc, 7
	fetch 2
@----------------------------------------------------------------------------
_CBBA:		@	RES 7,D		
@----------------------------------------------------------------------------
	opRESH gb_de, 7
	fetch 2
@----------------------------------------------------------------------------
_CBBB:		@	RES 7,E		
@----------------------------------------------------------------------------
	opRESL gb_de, 7
	fetch 2
@----------------------------------------------------------------------------
_CBBC:		@	RES 7,H		
@----------------------------------------------------------------------------
	opRESH gb_hl, 7
	fetch 2
@----------------------------------------------------------------------------
_CBBD:		@	RES 7,L		
@----------------------------------------------------------------------------
	opRESL gb_hl, 7
	fetch 2
@----------------------------------------------------------------------------
_CBBE:		@	RES 7,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opRESb r0, r1, 7
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBBF:		@	RES 7,A		
@----------------------------------------------------------------------------
	opRESH gb_a, 7
	fetch 2
@----------------------------------------------------------------------------
_CBC0:		@	SET 0,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 0
	fetch 2
@----------------------------------------------------------------------------
_CBC1:		@	SET 0,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 0 
	fetch 2
@----------------------------------------------------------------------------
_CBC2:		@	SET 0,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 0
	fetch 2
@----------------------------------------------------------------------------
_CBC3:		@	SET 0,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 0
	fetch 2
@----------------------------------------------------------------------------
_CBC4:		@	SET 0,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 0
	fetch 2
@----------------------------------------------------------------------------
_CBC5:		@	SET 0,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 0
	fetch 2
@----------------------------------------------------------------------------
_CBC6:		@	SET 0,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 0
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBC7:		@	SET 0,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 0
	fetch 2
@----------------------------------------------------------------------------
_CBC8:		@	SET 1,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 1
	fetch 2
@----------------------------------------------------------------------------
_CBC9:		@	SET 1,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 1 
	fetch 2
@----------------------------------------------------------------------------
_CBCA:		@	SET 1,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 1
	fetch 2
@----------------------------------------------------------------------------
_CBCB:		@	SET 1,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 1
	fetch 2
@----------------------------------------------------------------------------
_CBCC:		@	SET 1,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 1
	fetch 2
@----------------------------------------------------------------------------
_CBCD:		@	SET 1,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 1
	fetch 2
@----------------------------------------------------------------------------
_CBCE:		@	SET 1,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 1
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBCF:		@	SET 1,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 1
	fetch 2
@----------------------------------------------------------------------------
_CBD0:		@	SET 2,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 2
	fetch 2
@----------------------------------------------------------------------------
_CBD1:		@	SET 2,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 2 
	fetch 2
@----------------------------------------------------------------------------
_CBD2:		@	SET 2,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 2
	fetch 2
@----------------------------------------------------------------------------
_CBD3:		@	SET 2,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 2
	fetch 2
@----------------------------------------------------------------------------
_CBD4:		@	SET 2,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 2
	fetch 2
@----------------------------------------------------------------------------
_CBD5:		@	SET 2,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 2
	fetch 2
@----------------------------------------------------------------------------
_CBD6:		@	SET 2,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 2
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBD7:		@	SET 2,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 2
	fetch 2
@----------------------------------------------------------------------------
_CBD8:		@	SET 3,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 3
	fetch 2
@----------------------------------------------------------------------------
_CBD9:		@	SET 3,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 3 
	fetch 2
@----------------------------------------------------------------------------
_CBDA:		@	SET 3,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 3
	fetch 2
@----------------------------------------------------------------------------
_CBDB:		@	SET 3,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 3
	fetch 2
@----------------------------------------------------------------------------
_CBDC:		@	SET 3,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 3
	fetch 2
@----------------------------------------------------------------------------
_CBDD:		@	SET 3,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 3
	fetch 2
@----------------------------------------------------------------------------
_CBDE:		@	SET 3,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 3
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBDF:		@	SET 3,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 3
	fetch 2
@----------------------------------------------------------------------------
_CBE0:		@	SET 4,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 4
	fetch 2
@----------------------------------------------------------------------------
_CBE1:		@	SET 4,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 4 
	fetch 2
@----------------------------------------------------------------------------
_CBE2:		@	SET 4,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 4
	fetch 2
@----------------------------------------------------------------------------
_CBE3:		@	SET 4,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 4
	fetch 2
@----------------------------------------------------------------------------
_CBE4:		@	SET 4,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 4
	fetch 2
@----------------------------------------------------------------------------
_CBE5:		@	SET 4,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 4
	fetch 2
@----------------------------------------------------------------------------
_CBE6:		@	SET 4,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 4
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBE7:		@	SET 4,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 4
	fetch 2
@----------------------------------------------------------------------------
_CBE8:		@	SET 5,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 5
	fetch 2
@----------------------------------------------------------------------------
_CBE9:		@	SET 5,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 5 
	fetch 2
@----------------------------------------------------------------------------
_CBEA:		@	SET 5,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 5
	fetch 2
@----------------------------------------------------------------------------
_CBEB:		@	SET 5,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 5
	fetch 2
@----------------------------------------------------------------------------
_CBEC:		@	SET 5,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 5
	fetch 2
@----------------------------------------------------------------------------
_CBED:		@	SET 5,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 5
	fetch 2
@----------------------------------------------------------------------------
_CBEE:		@	SET 5,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 5
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBEF:		@	SET 5,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 5
	fetch 2
@----------------------------------------------------------------------------
_CBF0:		@	SET 6,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 6
	fetch 2
@----------------------------------------------------------------------------
_CBF1:		@	SET 6,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 6 
	fetch 2
@----------------------------------------------------------------------------
_CBF2:		@	SET 6,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 6
	fetch 2
@----------------------------------------------------------------------------
_CBF3:		@	SET 6,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 6
	fetch 2
@----------------------------------------------------------------------------
_CBF4:		@	SET 6,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 6
	fetch 2
@----------------------------------------------------------------------------
_CBF5:		@	SET 6,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 6
	fetch 2
@----------------------------------------------------------------------------
_CBF6:		@	SET 6,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 6
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBF7:		@	SET 6,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 6
	fetch 2
@----------------------------------------------------------------------------
_CBF8:		@	SET 7,B		
@----------------------------------------------------------------------------
	opSETH gb_bc, 7
	fetch 2
@----------------------------------------------------------------------------
_CBF9:		@	SET 7,C		
@----------------------------------------------------------------------------
	opSETL gb_bc, 7 
	fetch 2
@----------------------------------------------------------------------------
_CBFA:		@	SET 7,D		
@----------------------------------------------------------------------------
	opSETH gb_de, 7
	fetch 2
@----------------------------------------------------------------------------
_CBFB:		@	SET 7,E		
@----------------------------------------------------------------------------
	opSETL gb_de, 7
	fetch 2
@----------------------------------------------------------------------------
_CBFC:		@	SET 7,H		
@----------------------------------------------------------------------------
	opSETH gb_hl, 7
	fetch 2
@----------------------------------------------------------------------------
_CBFD:		@	SET 7,L		
@----------------------------------------------------------------------------
	opSETL gb_hl, 7
	fetch 2
@----------------------------------------------------------------------------
_CBFE:		@	SET 7,(HL)	
@----------------------------------------------------------------------------
	readmemHL
	opSETb r0, r1, 7
	writememHL
	fetch 4
@----------------------------------------------------------------------------
_CBFF:		@	SET 7,A		
@----------------------------------------------------------------------------
	opSETH gb_a, 7
	fetch 2	
@------------------------------------------------------------------------------


cpu_reset:
	stmfd sp!, {r4-r11,lr}
	ldr gb_cpu, ramcpu
	mov r0, #0
	mov r1, #40
	strb r0, [gb_cpu, #speed]
	strb r0, [gb_cpu, #halt]
	str r0, [gb_cpu, #div]	
	str r0, [gb_cpu, #tim]	
	str r0, [gb_cpu, #lcdc]	
	strb r0, [gb_cpu, #IME]
	strb r0, [gb_cpu, #IMA]
	mov gb_pc, #0x01000000
	mov r0, #0xFF000000
	orr r0, r0, #0xFE0000
	str r0, [gb_cpu, #SP]
	mov gb_a, #0x01000000
	mov r0, #0x01B0 
	decodeFLG
	mov gb_bc, #0x00130000
	mov gb_de, #0x00D80000
	mov gb_hl, #0x01000000
	orr gb_hl, gb_hl, #0x4D0000
	
	ldr r0, ramHW
	ldrb r0, [r0]
	cmp r0, #0
	movne gb_a, #0x11000000

	ldr r1, =reg_saves
	stmia r1!, {r4-r11}
	ldmfd sp!, {r4-r11,lr}
	bx lr

ramcpu:			/*TRICK TO LOAD object*/
	.word cpu_a
ramHW:
	.word hw+2


@@@@ NEW STUFF @@@@

emu_run:
	stmfd sp!, {r4-r11,lr}
	ldr r1, =reg_saves
	ldmia r1!, {r4-r11}
	bl _Z9lcd_beginv 
emu_run_for:
	mov cycles, #0xE8
	orr cycles, cycles, #0x800
	bl cpu_emulate
emu_while1_start:	
	ldrb r1, [gb_cpu, #R_LY]
	tst r1, r1
	beq emu_while1_end
	cmp r1, #143
	bhi emu_while1_end
	ldr cycles, [gb_cpu, #lcdc]
	bl cpu_emulate
	b emu_while1_start
emu_while1_end:
	ldrb r1, [gb_cpu, #R_LCDC]
	tst r1, #0x80
	moveq cycles, #0x8000
	orreq cycles, cycles, #0x40
	bleq cpu_emulate
emu_while2_start:
	ldrb r1, [gb_cpu, #R_LY]
	tst r1, r1
	beq emu_run_for
	ldr cycles, [gb_cpu, #lcdc]
	bl cpu_emulate
	b emu_while2_start	
emu_run_end:  /* Never called */
	ldr r1, =reg_saves
	stmia r1!, {r4-r11}
	ldmfd sp!, {r4-r11,lr}
	bx lr

cpu_emulate:
	stmfd sp!, {lr}
	cmp cycles, #0
	ble Ldone	

Lnext:
	ldrb r0, [gb_cpu,#halt]
	ldrb r1, [gb_cpu,#IME]
	tst r0,r1
	bne Lidle

Ldoop:
	/* check for pending interrupts */
	ldrb r0, [gb_cpu,#IME]
	tst r0, r0
	beq Lnoint
	ldrb r2, [gb_cpu,#R_IF]
	ldrb r1, [gb_cpu,#R_IE]
	ands r3, r1, r2
	bne Lint

Lnoint:
	/* update interrupt master enable */
	ldrb r0, [gb_cpu,#IMA]
	strb r0, [gb_cpu,#IME] 
	
Lendint:
	readPCByte
	
	ldr r1, op_j_addr
	ldr r1, [r1,r0,lsl#2]
	bx r1
op_j_addr:
	.word op_table

opdone:
	/* advance div */	
	ldrb r0, [gb_cpu, #div]
	ldrb r1, [gb_cpu, #R_DIV]
	orr r0, r0, r1, lsl#8
	add r0, r0, gb_opc,lsl#1
	strb r0, [gb_cpu, #div]
	mov r1, r0, lsr#8
	strb r1, [gb_cpu, #R_DIV]

	/* advance timer */
	ldrb r0, [gb_cpu, #R_TAC]
	tst r0, #0x04
	bne Ltimer 
	
Lendtimer:
	ldrb r0, [gb_cpu, #speed]	
	mov gb_opc, gb_opc, lsr r0
	sub cycles, cycles, gb_opc
	
	/* increment sound cycle counter */
	ldr r0, [gb_cpu, #snd]
	add r0, r0, gb_opc
	str r0, [gb_cpu, #snd]
	
	/* advance lcdc */
	ldr r0, [gb_cpu, #lcdc]
	subs r0, r0, gb_opc
	str r0, [gb_cpu, #lcdc]
	bgt Lnolcdc
	bl _Z10lcdc_transv
	
Lnolcdc:	
	cmp cycles, #0
	bgt Lnext
	b 	Ldone
	
Lint:	
	/* throw an interrupt */
		
	mov r0, #0
	strb r0, [gb_cpu, #halt]
	strb r0, [gb_cpu, #IMA]
	strb r0, [gb_cpu, #IME]
	tst r3, #0x1
	bne int0
	tst r3, #0x2
	bne int1
	tst r3, #0x4
	bne int2
	tst r3, #0x8
	bne int3
	tst r3, #0x10
	bne int4
	b Lendint
	
int0:
	bic r2, r2, #0x1
	strb r2, [gb_cpu,#R_IF]
	ldr r0, [gb_cpu,#SP]
	sub r0,r0,#0x00020000
	str r0, [gb_cpu,#SP]
	mov r0, r0, lsr#16
	mov r1, gb_pc, lsr#16
	writew
	mov gb_pc, #0x00400000
	b Lendint	
int1:
	bic r2, r2, #0x2
	strb r2, [gb_cpu,#R_IF]
	ldr r0, [gb_cpu,#SP]
	sub r0,r0,#0x00020000
	str r0, [gb_cpu,#SP]
	mov r0, r0, lsr#16
	mov r1, gb_pc, lsr#16
	writew
	mov gb_pc, #0x00480000
	b Lendint
int2:
	bic r2, r2, #0x4
	strb r2, [gb_cpu,#R_IF]
	ldr r0, [gb_cpu,#SP]
	sub r0,r0,#0x00020000
	str r0, [gb_cpu,#SP]
	mov r0, r0, lsr#16
	mov r1, gb_pc, lsr#16
	writew
	mov gb_pc, #0x00500000
	b Lendint
int3:	
	bic r2, r2, #0x8
	strb r2, [gb_cpu,#R_IF]
	ldr r0, [gb_cpu,#SP]
	sub r0,r0,#0x00020000
	str r0, [gb_cpu,#SP]
	mov r0, r0, lsr#16
	mov r1, gb_pc, lsr#16
	writew
	mov gb_pc, #0x00580000
	b Lendint
int4:	
	bic r2, r2, #0x10
	strb r2, [gb_cpu,#R_IF]
	ldr r0, [gb_cpu,#SP]
	sub r0,r0,#0x00020000
	str r0, [gb_cpu,#SP]
	mov r0, r0, lsr#16
	mov r1, gb_pc, lsr#16
	writew
	mov gb_pc, #0x00600000
	b Lendint
	
Ltimer:

	eor r0, r0, #0xFF
	add r0, r0, #1
	and r0, r0, #0x3
	mov r0, r0, lsl#1			@r0 - unit
	ldr r1, [gb_cpu, #tim]

	add  r2, r1, gb_opc, lsl r0
	str  r2, [gb_cpu, #tim] 
	cmp r2, #512
	blt Lendtimer
	
	mov r1, r2, lsr#9			@r1 = cpu_a.tim >> 9
	mov r0, #0xFF
	orr r0, r0, #0x100			@r0 = 0x1FF
	and r2, r2, r0		
	str r2, [gb_cpu,#tim]		
	ldrb r0, [gb_cpu, #R_TIMA]
	add r1, r1, r0
	strb r1, [gb_cpu, #R_TIMA]
	cmp r1, #256
	blt Lendtimer	
	
	ldrb r0, [gb_cpu, #R_IF]
	orr r0, r0, #4
	strb r0, [gb_cpu, #R_IF]
	mov r0, #256
	ldrb r2, [gb_cpu, #R_TMA]
	sub r1, r1, #256
	sub r0, r0, r2
	
Ltimermod:
	subs r0,r0,r1
	bcc Ltimermod
	strb r0, [gb_cpu, #R_TIMA]
	b Lendtimer
	
Ldone:
	ldmfd sp!, {lr}
	bx lr
	
Lidle:		
	mov r0, cycles
	bl _Z8cpu_idlei		
	tst r0,r0
	beq Ldoop
	
	subs cycles, cycles, r0
	bgt Lnext
	b Ldone	
	
reg_saves:
	.word 0,0,0,0,0,0,0,0
lr_save:
	.word 0
cb_table:
	.word _CB00,_CB01,_CB02,_CB03,_CB04,_CB05,_CB06,_CB07,_CB08,_CB09,_CB0A,_CB0B,_CB0C,_CB0D,_CB0E,_CB0F
	.word _CB10,_CB11,_CB12,_CB13,_CB14,_CB15,_CB16,_CB17,_CB18,_CB19,_CB1A,_CB1B,_CB1C,_CB1D,_CB1E,_CB1F
	.word _CB20,_CB21,_CB22,_CB23,_CB24,_CB25,_CB26,_CB27,_CB28,_CB29,_CB2A,_CB2B,_CB2C,_CB2D,_CB2E,_CB2F
	.word _CB30,_CB31,_CB32,_CB33,_CB34,_CB35,_CB36,_CB37,_CB38,_CB39,_CB3A,_CB3B,_CB3C,_CB3D,_CB3E,_CB3F
	.word _CB40,_CB41,_CB42,_CB43,_CB44,_CB45,_CB46,_CB47,_CB48,_CB49,_CB4A,_CB4B,_CB4C,_CB4D,_CB4E,_CB4F
	.word _CB50,_CB51,_CB52,_CB53,_CB54,_CB55,_CB56,_CB57,_CB58,_CB59,_CB5A,_CB5B,_CB5C,_CB5D,_CB5E,_CB5F
	.word _CB60,_CB61,_CB62,_CB63,_CB64,_CB65,_CB66,_CB67,_CB68,_CB69,_CB6A,_CB6B,_CB6C,_CB6D,_CB6E,_CB6F
	.word _CB70,_CB71,_CB72,_CB73,_CB74,_CB75,_CB76,_CB77,_CB78,_CB79,_CB7A,_CB7B,_CB7C,_CB7D,_CB7E,_CB7F
	.word _CB80,_CB81,_CB82,_CB83,_CB84,_CB85,_CB86,_CB87,_CB88,_CB89,_CB8A,_CB8B,_CB8C,_CB8D,_CB8E,_CB8F
	.word _CB90,_CB91,_CB92,_CB93,_CB94,_CB95,_CB96,_CB97,_CB98,_CB99,_CB9A,_CB9B,_CB9C,_CB9D,_CB9E,_CB9F
	.word _CBA0,_CBA1,_CBA2,_CBA3,_CBA4,_CBA5,_CBA6,_CBA7,_CBA8,_CBA9,_CBAA,_CBAB,_CBAC,_CBAD,_CBAE,_CBAF
	.word _CBB0,_CBB1,_CBB2,_CBB3,_CBB4,_CBB5,_CBB6,_CBB7,_CBB8,_CBB9,_CBBA,_CBBB,_CBBC,_CBBD,_CBBE,_CBBF
	.word _CBC0,_CBC1,_CBC2,_CBC3,_CBC4,_CBC5,_CBC6,_CBC7,_CBC8,_CBC9,_CBCA,_CBCB,_CBCC,_CBCD,_CBCE,_CBCF
	.word _CBD0,_CBD1,_CBD2,_CBD3,_CBD4,_CBD5,_CBD6,_CBD7,_CBD8,_CBD9,_CBDA,_CBDB,_CBDC,_CBDD,_CBDE,_CBDF
	.word _CBE0,_CBE1,_CBE2,_CBE3,_CBE4,_CBE5,_CBE6,_CBE7,_CBE8,_CBE9,_CBEA,_CBEB,_CBEC,_CBED,_CBEE,_CBEF
	.word _CBF0,_CBF1,_CBF2,_CBF3,_CBF4,_CBF5,_CBF6,_CBF7,_CBF8,_CBF9,_CBFA,_CBFB,_CBFC,_CBFD,_CBFE,_CBFF

op_table:
	.word _00,_01,_02,_03,_04,_05,_06,_07,_08,_09,_0A,_0B,_0C,_0D,_0E,_0F
	.word _10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1A,_1B,_1C,_1D,_1E,_1F
	.word _20,_21,_22,_23,_24,_25,_26,_27,_28,_29,_2A,_2B,_2C,_2D,_2E,_2F
	.word _30,_31,_32,_33,_34,_35,_36,_37,_38,_39,_3A,_3B,_3C,_3D,_3E,_3F
	.word _40,_41,_42,_43,_44,_45,_46,_47,_48,_49,_4A,_4B,_4C,_4D,_4E,_4F
	.word _50,_51,_52,_53,_54,_55,_56,_57,_58,_59,_5A,_5B,_5C,_5D,_5E,_5F
	.word _60,_61,_62,_63,_64,_65,_66,_67,_68,_69,_6A,_6B,_6C,_6D,_6E,_6F
	.word _70,_71,_72,_73,_74,_75,_76,_77,_78,_79,_7A,_7B,_7C,_7D,_7E,_7F
	.word _80,_81,_82,_83,_84,_85,_86,_87,_88,_89,_8A,_8B,_8C,_8D,_8E,_8F
	.word _90,_91,_92,_93,_94,_95,_96,_97,_98,_99,_9A,_9B,_9C,_9D,_9E,_9F
	.word _A0,_A1,_A2,_A3,_A4,_A5,_A6,_A7,_A8,_A9,_AA,_AB,_AC,_AD,_AE,_AF
	.word _B0,_B1,_B2,_B3,_B4,_B5,_B6,_B7,_B8,_B9,_BA,_BB,_BC,_BD,_BE,_BF
	.word _C0,_C1,_C2,_C3,_C4,_C5,_C6,_C7,_C8,_C9,_CA,_CB,_CC,_CD,_CE,_CF
	.word _D0,_D1,_D2,_xx,_D4,_D5,_D6,_D7,_D8,_D9,_DA,_xx,_DC,_xx,_DE,_DF
	.word _E0,_E1,_E2,_xx,_xx,_E5,_E6,_E7,_E8,_E9,_EA,_xx,_xx,_xx,_EE,_EF
	.word _F0,_F1,_F2,_F3,_xx,_F5,_F6,_F7,_F8,_F9,_FA,_FB,_xx,_xx,_FE,_FF	

